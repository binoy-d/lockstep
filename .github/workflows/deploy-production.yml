name: deploy-production

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy lockstep.binoy.co
    if: ${{ github.event.repository.private == false }}
    runs-on:
      - self-hosted
      - lockstep
    environment: production

    steps:
      - name: Deploy on self-hosted runner
        run: |
          set -euo pipefail
          cd /home/daniel/dev/lockstep
          current_branch=$(git branch --show-current)
          if [ "$current_branch" != "main" ]; then
            git checkout main
          fi
          git fetch origin main
          git pull --ff-only origin main
          docker-compose up -d --build
          docker-compose ps
