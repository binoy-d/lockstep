name: deploy-production

on:
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy lockstep.binoy.co
    if: ${{ github.event.repository.private == false }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy over SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          password: ${{ secrets.DEPLOY_PASSWORD }}
          script_stop: true
          timeout: 30m
          command_timeout: 30m
          script: |
            set -euo pipefail
            cd /home/daniel/dev/lockstep
            current_branch=$(git branch --show-current)
            if [ "$current_branch" != "main" ]; then
              git checkout main
            fi
            git fetch origin main
            git pull --ff-only origin main
            docker-compose up -d --build
            docker-compose ps
